#!/bin/bash
# Pre-commit hook for legalis project
# This script runs before each commit to ensure code quality

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $2"
    else
        echo -e "${RED}âœ—${NC} $2"
        return 1
    fi
}

print_info() {
    echo -e "${YELLOW}âžœ${NC} $1"
}

# Check if we're in the legalis project root
if [ ! -f "Cargo.toml" ]; then
    echo -e "${RED}Error: Not in project root directory${NC}"
    exit 1
fi

# Track overall status
FAILED=0

# 1. Check code formatting
print_info "Checking code formatting..."
if cargo fmt --all -- --check > /dev/null 2>&1; then
    print_status 0 "Code formatting check passed"
else
    print_status 1 "Code formatting check failed"
    echo -e "${YELLOW}Run 'cargo fmt --all' to fix formatting issues${NC}"
    FAILED=1
fi

# 2. Run Clippy lints
print_info "Running Clippy lints..."
if cargo clippy --all-targets --all-features -- -D warnings > /dev/null 2>&1; then
    print_status 0 "Clippy check passed"
else
    print_status 1 "Clippy check failed"
    echo -e "${YELLOW}Run 'cargo clippy --all-targets --all-features -- -D warnings' to see issues${NC}"
    FAILED=1
fi

# 3. Build the project
print_info "Building project..."
if cargo build --all-targets --all-features > /dev/null 2>&1; then
    print_status 0 "Build successful"
else
    print_status 1 "Build failed"
    echo -e "${YELLOW}Run 'cargo build --all-targets --all-features' to see errors${NC}"
    FAILED=1
fi

# 4. Run tests (skip if SKIP_TESTS is set)
if [ -z "$SKIP_TESTS" ]; then
    print_info "Running tests..."
    if cargo test --all-features > /dev/null 2>&1; then
        print_status 0 "All tests passed"
    else
        print_status 1 "Tests failed"
        echo -e "${YELLOW}Run 'cargo test --all-features' to see test failures${NC}"
        echo -e "${YELLOW}Tip: Set SKIP_TESTS=1 to skip tests in pre-commit hook${NC}"
        FAILED=1
    fi
else
    echo -e "${YELLOW}âŠ˜${NC} Tests skipped (SKIP_TESTS is set)"
fi

# 5. Check for common issues
print_info "Checking for common issues..."

# Check for TODO comments in staged files
TODO_COUNT=$(git diff --cached --name-only | xargs grep -n "TODO\|FIXME\|XXX" 2>/dev/null | wc -l)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš ${NC}  Found $TODO_COUNT TODO/FIXME/XXX comments in staged files"
fi

# Check for debug print statements
DEBUG_COUNT=$(git diff --cached --name-only | grep "\.rs$" | xargs grep -n "println!\|dbg!\|eprintln!" 2>/dev/null | grep -v "^//" | grep -v "^\s*//" | wc -l)
if [ "$DEBUG_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš ${NC}  Found $DEBUG_COUNT debug print statements in staged files"
fi

# Check for large files (> 1MB)
LARGE_FILES=$(git diff --cached --name-only | xargs ls -l 2>/dev/null | awk '$5 > 1048576 {print $9}')
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ${NC}  Large files detected (>1MB):"
    echo "$LARGE_FILES"
fi

print_status 0 "Common issues check completed"

# 6. Check documentation
print_info "Checking documentation..."
if cargo doc --all-features --no-deps > /dev/null 2>&1; then
    print_status 0 "Documentation builds successfully"
else
    print_status 1 "Documentation build failed"
    echo -e "${YELLOW}Run 'cargo doc --all-features --no-deps' to see errors${NC}"
    FAILED=1
fi

# Final status
echo ""
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    exit 0
else
    echo -e "${RED}âœ— Some pre-commit checks failed${NC}"
    echo -e "${YELLOW}Fix the issues above before committing${NC}"
    echo -e "${YELLOW}Or use 'git commit --no-verify' to skip these checks (not recommended)${NC}"
    exit 1
fi
